name: Build Release

on:
  push:
    branches: [ "master" ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-appimage:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    outputs:
      appimage_name: ${{ steps.bundle.outputs.appimage_name }}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake ninja-build \
          libcurl4-openssl-dev libzip-dev \
          libvulkan-dev vulkan-validationlayers-dev \
          libglfw3-dev libgl1-mesa-dev \
          libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
          desktop-file-utils appstream fuse libfuse2

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr

    - name: Build
      run: cmake --build build --parallel $(nproc)

    - name: Install to AppDir
      run: |
        mkdir -p AppDir
        DESTDIR=$(pwd)/AppDir cmake --install build

    - name: Download linuxdeploy
      run: |
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage

    - name: Create AppImage
      id: bundle
      run: |
        VERSION="${GITHUB_REF_NAME:-1.0.${{ github.run_number }}}"
        
        # Ensure desktop file and icon are in place
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/512x512/apps
        cp rsjfw.desktop AppDir/usr/share/applications/
        cp assets/logo.png AppDir/usr/share/icons/hicolor/512x512/apps/rsjfw.png
        
        # Create AppImage
        ./linuxdeploy-x86_64.AppImage \
          --appdir AppDir \
          --desktop-file=rsjfw.desktop \
          --icon-file=assets/logo.png \
          --output appimage
        
        APPIMAGE_NAME="rsjfw-${VERSION}-x86_64.AppImage"
        mv RSJFW*.AppImage "$APPIMAGE_NAME" || mv *.AppImage "$APPIMAGE_NAME"
        echo "appimage_name=$APPIMAGE_NAME" >> $GITHUB_OUTPUT

    - name: Upload AppImage Artifact
      uses: actions/upload-artifact@v4
      with:
        name: appimage
        path: "*.AppImage"

  build-arch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    container: archlinux:latest
    outputs:
      arch_tarball_name: ${{ steps.package.outputs.arch_tarball_name }}
      sha: ${{ steps.sha.outputs.sha }}
      pkgver: ${{ steps.package.outputs.pkgver }}

    steps:
    - name: Install System Dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm base-devel git cmake ninja libzip curl vulkan-icd-loader vulkan-headers glfw libglvnd libx11 libxrandr libxinerama libxcursor libxi

    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Fix Git Safety
      run: git config --global --add safe.directory $GITHUB_WORKSPACE

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr

    - name: Build
      run: cmake --build build --parallel $(nproc)

    - name: Install to Staging
      run: |
        mkdir -p staging
        DESTDIR=$(pwd)/staging cmake --install build

    - name: Create Tarball
      id: package
      run: |
        VERSION="${GITHUB_REF_NAME}"
        if [[ ! $VERSION =~ ^v[0-9] ]]; then
          VERSION="v1.0.${{ github.run_number }}"
        fi
        PKGVER="${VERSION#v}"
        TARBALL_NAME="rsjfw-${PKGVER}-arch-x86_64.tar.gz"
        
        cd staging
        tar -czvf "../$TARBALL_NAME" usr
        cd ..
        
        echo "arch_tarball_name=$TARBALL_NAME" >> $GITHUB_OUTPUT
        echo "pkgver=$PKGVER" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Calculate SHA256
      id: sha
      run: |
        SHA=$(sha256sum rsjfw-*-arch-x86_64.tar.gz | awk '{print $1}')
        echo "sha=$SHA" >> $GITHUB_OUTPUT

    - name: Upload Arch Artifact
      uses: actions/upload-artifact@v4
      with:
        name: arch-tarball
        path: "*.tar.gz"

  release:
    needs: [build-appimage, build-arch]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare Release Files
      run: |
        mkdir -p release_files
        cp artifacts/appimage/*.AppImage release_files/
        cp artifacts/arch-tarball/*.tar.gz release_files/
        ls -R release_files/

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release_files/*
        generate_release_notes: true
        fail_on_unmatched_files: true

    - name: Prepare AUR Package
      run: |
        mkdir -p aur_deploy
        cp packaging/aur/PKGBUILD aur_deploy/
        cp rsjfw.install aur_deploy/
        
        PKGVER="${{ needs.build-arch.outputs.pkgver }}"
        SHA="${{ needs.build-arch.outputs.sha }}"
        
        sed -i "s/pkgver=0.0.0/pkgver=$PKGVER/" aur_deploy/PKGBUILD
        sed -i "0,/SKIP/s/SKIP/$SHA/" aur_deploy/PKGBUILD
        
        cat aur_deploy/PKGBUILD
        
    - name: Publish to AUR
      uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
      with:
        pkgname: rsjfw
        pkgbuild: ./aur_deploy/PKGBUILD
        assets: ./aur_deploy/rsjfw.install
        commit_username: ${{ secrets.AUR_USERNAME }}
        commit_email: ${{ secrets.AUR_EMAIL }}
        ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        commit_message: "Update to ${{ github.ref_name }}"
        ssh_keyscan_types: rsa,ecdsa,ed25519
