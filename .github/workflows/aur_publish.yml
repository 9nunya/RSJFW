name: Build and Push AUR Package

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed for creating releases

    container: archlinux:latest

    steps:
    - name: Install System Dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm base-devel git cmake ninja libzip curl vulkan-icd-loader vulkan-headers glfw libglvnd libx11 libxrandr libxinerama libxcursor libxi

    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Fix Git Safety
      run: git config --global --add safe.directory $GITHUB_WORKSPACE

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr

    - name: Build
      run: cmake --build build --parallel $(nproc) -j$(nproc)

    - name: Install to Staging
      run: |
        mkdir -p staging
        DESTDIR=$(pwd)/staging cmake --install build

    - name: Create Tarball
      run: |
        PKGVER="1.0.${{ github.run_number }}"
        TAG="v$PKGVER"
        echo "VERSION=$TAG" >> $GITHUB_ENV
        echo "PKGVER=$PKGVER" >> $GITHUB_ENV
        
        # Tar the contents of staging
        # Structure: rsjfw-<ver>-x86_64.tar.gz containing usr/...
        cd staging
        tar -czvf ../rsjfw-${PKGVER}-x86_64.tar.gz usr
        cd ..

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.VERSION }}
        files: rsjfw-${{ env.PKGVER }}-x86_64.tar.gz
        fail_on_unmatched_files: true

    - name: Calculate SHA256
      id: sha
      run: |
        SHA=$(sha256sum rsjfw-${{ env.PKGVER }}-x86_64.tar.gz | awk '{print $1}')
        echo "SHA=$SHA" >> $GITHUB_ENV

    - name: Prepare AUR Package
      run: |
        mkdir -p aur_deploy
        cp packaging/aur/PKGBUILD aur_deploy/
        
        # Update PKGBUILD with version and hash
        sed -i "s/pkgver=0.0.0/pkgver=${{ env.PKGVER }}/" aur_deploy/PKGBUILD
        sed -i "s/sha256sums=('SKIP')/sha256sums=('${{ env.SHA }}')/" aur_deploy/PKGBUILD
        
        # Verify content
        cat aur_deploy/PKGBUILD
        
    - name: Publish to AUR
      uses: KSXGitHub/github-actions-deploy-aur@v2.7.2
      with:
        pkgname: rsjfw
        pkgbuild: ./aur_deploy/PKGBUILD
        commit_username: ${{ secrets.AUR_USERNAME }}
        commit_email: ${{ secrets.AUR_EMAIL }}
        ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        commit_message: "Update to ${{ env.VERSION }}"
        ssh_keyscan_types: rsa,ecdsa,ed25519
